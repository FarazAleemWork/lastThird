#cloud-config
package_update: true
packages:
  - docker.io
  - docker-compose
  - certbot

write_files:
  - path: /opt/tahajjud/docker-compose.yml
    permissions: '0644'
    content: |
      ${indent(6, compose_content)}
  - path: /opt/tahajjud/nginx.conf
    permissions: '0644'
    content: |
      ${indent(6, nginx_content)}

bootcmd: 
  - apt-get update
  - apt-get install ca-certificates curl
  - apt-get install -y docker.io docker-compose
  - sudo install -m 0755 -d /etc/apt/keyrings
  - sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
  - sudo chmod a+r /etc/apt/keyrings/docker.asc
  - echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo "$VERSION_CODENAME") stable" > /etc/apt/sources.list.d/docker.list
  - sudo apt-get install docker-compose-plugin
  - systemctl enable docker
  - echo "docker enabling" >> /var/log/cloud-init-output.log

runcmd:
  - echo "docker debug" >> /var/log/cloud-init-output.log
  - bash -c 'until docker info >/dev/null 2>&1; do echo "waiting for docker..."; sleep 5; done'
  #- certbot certonly --standalone -d whenistahajjud.com --non-interactive --agree-tos -m you@example.com
  - until [ -f /opt/tahajjud/docker-compose.yml ]; do sleep 1; done
  - echo "we are here" >> /var/log/cloud-init-output.log
  - docker-compose -f /opt/tahajjud/docker-compose.yml up -d
  - docker-compose restart nginx